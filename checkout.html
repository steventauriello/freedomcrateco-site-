<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Your Cart – Freedom Crate Co.</title>
  <meta name="description" content="Review your cart, update quantities, and checkout securely. Free shipping on all handcrafted ammo & range boxes." />
  <link rel="canonical" href="https://freedomcrateco.com/checkout.html">
  <link rel="stylesheet" href="assets/css/styles.css" />
  <style>
    .cart-wrap{max-width:900px;margin:2rem auto}
    .cart-card{border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:1rem;background:rgba(255,255,255,.02)}
    .cart-row{display:grid;grid-template-columns:auto 1fr auto;gap:1rem;align-items:center;padding:1rem 0;border-top:1px solid rgba(255,255,255,.06)}
    .cart-row:first-child{border-top:0;padding-top:0}
    .cart-row img{width:84px;height:84px;object-fit:cover;border-radius:8px}
    .qty{display:flex;align-items:center;gap:.5rem}
    .qty button{width:36px;height:36px;border-radius:8px}
    .remove-btn{background:#e85b5b;border:none;color:#fff;padding:.5rem .9rem;border-radius:8px;cursor:pointer}
    .totals{display:flex;justify-content:flex-end;gap:2rem;margin:1rem 0 1.25rem}
    /* make labels line up nicely on small screens */
.totals div {
  min-width:200px;
  display:flex;
  justify-content:flex-end;
  gap:.75rem;
}
.totals div strong,
.totals div > span:first-child {
  flex:0 0 auto;
  text-align:right;
}

@media (max-width:480px){
  .totals div { min-width:140px; }
}
    #paypal-buttons{margin-top:1rem}
    .empty{padding:2.5rem;text-align:center;color:rgba(255,255,255,.7);border:1px dashed rgba(255,255,255,.2);border-radius:10px}
    .skip-link{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    .skip-link:focus{position:static;width:auto;height:auto;padding:.5rem;background:#000;color:#fff;border-radius:.25rem}
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>

  <header class="site-header">
    <a class="brand" href="index.html">
      <img src="assets/img/logo.png" alt="Freedom Crate Co." height="60" width="60">
    </a>
    <nav class="nav" aria-label="Primary">
  <a class="active" href="index.html">Shop</a>
  <a href="contact.html">Custom Orders</a>
  <a href="reviews.html">Reviews</a>
  <a href="checkout.html">Cart (<span id="cartCount">0</span>)</a>
</nav>
  </header>

  <main class="container cart-wrap" id="main">
    <h1>Your Cart</h1>

    <div id="cartContainer" class="cart-card" aria-live="polite"></div>

    <div class="totals" id="totals" hidden>
      <div><strong>Subtotal</strong> <span id="subtotal">$0.00</span></div>
      <div><span>Shipping</span> <span>Free</span></div>
    </div>
    <div class="muted" role="note" aria-label="Returns policy">
  <p>Standard items may be returned within 14 days. Buyer pays return shipping.</p>
  <p>Custom orders are final sale — no returns or exchanges.</p>
</div>

    <div id="actions" hidden>
      <div id="paypal-buttons"></div>
    </div>

    <p class="muted">US Veteran-inspired • Florida-built</p>
    <p class="muted">Rugged, practical, and made to be used.</p>
  </main>

  <!-- Core site helpers -->
  <script src="assets/js/util.js" defer></script>
  <script src="assets/js/config.js" defer></script>
  <script src="assets/js/cart.js" defer></script>

  <!-- PayPal Smart Buttons (replace with your live client-id when ready) -->
  <script src="https://www.paypal.com/sdk/js?client-id=Acgmdk8HBF7vwWZVVlNSWaSkUmiS_d8W9sPUYL3ChpldJtFOmboTxRro0ZyTxSGN8fH52gMsgcDMEDWU&currency=USD" defer></script>
  <script>
  (function () {
    const container = document.getElementById('cartContainer');
    const subtotalEl = document.getElementById('subtotal');
    const totalsBox  = document.getElementById('totals');
    const actionsBox = document.getElementById('actions');

    const fmt = (n) => '$' + (Number(n||0)).toFixed(2);
    const escapeHtml = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    function render(){
      const cart = readCart(); // from cart.js

      if (!cart.length){
        container.innerHTML = '<div class="empty">Your cart is empty.</div>';
        totalsBox.hidden = true;
        actionsBox.hidden = true;
        teardownPayPal();
        return;
      }

      container.innerHTML = '';
      cart.forEach((item) => {
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.dataset.sku = item.sku;

        const img = document.createElement('img');
        const src = (item.meta && item.meta.image) ? item.meta.image : (item.image || 'assets/img/blank.jpg');
        img.src = src;
        img.alt = item.name || 'Item';

        const meta = document.createElement('div');
        meta.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
            <div>
              <div style="font-weight:600">${escapeHtml(item.name || 'Item')}</div>
              <div class="muted">SKU: ${escapeHtml(item.sku || '')}</div>
            </div>
            <div style="min-width:90px;text-align:right">${fmt(item.price || 0)}</div>
          </div>
          <div class="qty" style="margin-top:.5rem;">
            <button class="btn" data-dec type="button" aria-label="Decrease quantity">–</button>
            <span aria-live="polite">${item.qty || 1}</span>
            <button class="btn" data-inc type="button" aria-label="Increase quantity">+</button>
          </div>
        `;

        const remove = document.createElement('button');
        remove.className = 'remove-btn';
        remove.type = 'button';
        remove.textContent = 'Remove';

        row.appendChild(img);
        row.appendChild(meta);
        row.appendChild(remove);
        container.appendChild(row);

        // wire qty / remove using SKU (stable id)
        meta.querySelector('[data-inc]').addEventListener('click', () => {
          const current = readCart().find(i => i.sku === item.sku);
          const nextQty = (current?.qty || 1) + 1;
          setQty(item.sku, nextQty);
        });
        meta.querySelector('[data-dec]').addEventListener('click', () => {
          const current = readCart().find(i => i.sku === item.sku);
          const nextQty = Math.max(1, (current?.qty || 1) - 1);
          setQty(item.sku, nextQty);
        });
        remove.addEventListener('click', () => {
          removeItem(item.sku);
        });
      });

      subtotalEl.textContent = fmt(cartTotal(readCart()));
      totalsBox.hidden = false;
      actionsBox.hidden = false;
      setupPayPal();
    }

    // --- PayPal buttons lifecycle ---
    let paypalButtonsInstance = null;

    function teardownPayPal(){
      if (paypalButtonsInstance && paypalButtonsInstance.isEligible && paypalButtonsInstance.isEligible()) {
        try { paypalButtonsInstance.close(); } catch(_){}
      }
      const holder = document.getElementById('paypal-buttons');
      if (holder) holder.innerHTML = '';
      paypalButtonsInstance = null;
    }

    function setupPayPal(){
      if (!window.paypal || !paypal.Buttons){ setTimeout(setupPayPal, 100); return; }
      teardownPayPal();

      paypalButtonsInstance = paypal.Buttons({
        style: { layout: 'vertical', shape: 'rect', label: 'paypal' },
        createOrder: (data, actions) => {
          const total = cartTotal(readCart());
          if (total <= 0) return;
          return actions.order.create({
            purchase_units: [{ amount: { value: total.toFixed(2) } }]
          });
        },
        onApprove: (data, actions) => {
          return actions.order.capture().then(() => {
            clearCart(); // use API so badge & events stay in sync
            window.location.href = 'thanks.html';
          });
        },
        onError: (err) => {
          console.error('PayPal error', err);
          alert('There was an issue with PayPal. Please try again.');
        }
      });

      if (paypalButtonsInstance.isEligible()){
        paypalButtonsInstance.render('#paypal-buttons');
      }
    }

    // initial render + sync
    document.addEventListener('DOMContentLoaded', render);
    // Re-render when the cart changes (same-tab updates)
    window.addEventListener('cart:updated', render);
    // Cross-tab updates also dispatch 'storage' from cart.js; re-render anyway:
    window.addEventListener('storage', render);
  })();
  </script>
</body>
</html>