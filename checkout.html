<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Freedom Crate Co. – Cart</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
  <style>
    .container { max-width: 1000px; margin: 0 auto; padding: 1.25rem; }
    .cart-wrap { border:1px solid rgba(255,255,255,.1); border-radius:8px; padding:1rem; }
    .cart-row { display:grid; grid-template-columns: 64px 1fr auto auto auto; gap:1rem; align-items:center; padding:.75rem 0; border-bottom:1px solid rgba(255,255,255,.06); }
    .cart-row:last-child { border-bottom:0; }
    .thumb { width:64px; height:64px; object-fit:cover; border-radius:6px; background:rgba(255,255,255,.08); }
    .title { font-weight:600; }
    .subtitle { opacity:.8; font-size:.9rem; }
    .qty-controls { display:flex; align-items:center; gap:.5rem; }
    .btn { padding:.4rem .7rem; border-radius:6px; cursor:pointer; }
    .muted { opacity:.75; }
    .right { text-align:right; }
    .totals { display:flex; justify-content:flex-end; gap:2rem; margin-top:1rem; }
    .totals div { min-width: 200px; }
    .actions { display:flex; justify-content:flex-end; gap:.75rem; margin-top:1rem; }
    .empty { text-align:center; padding:2rem 0; opacity:.8; }
    @media (max-width: 720px){
      .cart-row { grid-template-columns: 56px 1fr auto; align-items:start; }
      .cart-row .price, .cart-row .qty, .cart-row .remove { justify-self:end; }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <a class="brand" href="index.html">
      <img src="assets/img/logo.png" alt="Freedom Crate Co. logo" height="60">
    </a>
    <nav class="nav">
      <a href="index.html">Shop</a>
      <a href="contact.html">Custom Orders</a>
      <a href="checkout.html">Cart (<span id="cartCount">0</span>)</a>
    </nav>
  </header>

  <main class="container">
    <h1>Your Cart</h1>
    <div id="cart" class="cart-wrap" aria-live="polite"></div>

    <div class="actions">
      <button id="clearCart" class="btn">Empty Cart</button>
      <button id="checkout" class="btn">Proceed to Checkout</button>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <span class="badge">US Veteran-inspired • Florida-built</span>
      <p class="muted">Rugged, practical, and made to be used.</p>
    </div>
  </footer>

  <!-- Scripts (order matters: we use readCart/saveCart from cart.js) -->
  <script src="assets/js/util.js"></script>
  <script src="assets/js/config.js"></script>
  <script src="assets/js/data.js"></script>
  <script src="assets/js/cart.js"></script>

  <script>
  (function(){
    const el = document.getElementById('cart');

    function money(n){ return `$${Number(n).toFixed(2)}`; }

    function render(){
      const cart = readCart(); // from cart.js
      if (!cart || cart.length === 0){
        el.innerHTML = `<div class="empty">Your cart is empty.</div>`;
        return;
      }

      let html = '';
      let subtotal = 0;

      cart.forEach(item => {
        const qty   = item.qty ?? item.quantity ?? 1;
        const price = Number(item.price ?? 0);
        const line  = price * qty;
        subtotal += line;

        // Build a friendly subtitle from name if you encoded options there
        const title = item.name ?? item.title ?? 'Item';
        const parts = String(title).split('—'); // e.g., "Standard Ammo Box — Army • Stainless"
        const main  = parts[0]?.trim() || title;
        const sub   = parts.slice(1).join('—').trim();

        const img   = item.image || 'assets/img/blank.jpg';

        html += `
          <div class="cart-row" data-sku="${item.sku}">
            <img class="thumb" src="${img}" alt="">
            <div>
              <div class="title">${main}</div>
              ${sub ? `<div class="subtitle">${sub}</div>` : ''}
              <div class="muted">SKU: ${item.sku}</div>
            </div>
            <div class="price right">${money(price)}</div>
            <div class="qty qty-controls">
              <button class="btn dec" aria-label="Decrease quantity">−</button>
              <span>${qty}</span>
              <button class="btn inc" aria-label="Increase quantity">+</button>
            </div>
            <div class="remove right">
              <button class="btn danger remove-item">Remove</button>
            </div>
          </div>
        `;
      });

      html += `
        <div class="totals">
          <div class="right">
            <div class="muted">Subtotal</div>
            <div><strong>${money(subtotal)}</strong></div>
            <div class="muted" style="font-size:.9rem;margin-top:.25rem;">Free shipping.</div>
          </div>
        </div>
      `;

      el.innerHTML = html;
    }

    // Event delegation for quantity and remove
    document.addEventListener('click', (e) => {
      const row = e.target.closest('.cart-row');
      const cart = readCart();

      // Remove
      if (e.target.closest('.remove-item') && row){
        const sku = row.dataset.sku;
        const next = cart.filter(it => it.sku !== sku);
        saveCart(next); // from cart.js (also updates badge)
        render();
        return;
      }

      // Increase / Decrease
      if (row && (e.target.closest('.inc') || e.target.closest('.dec'))){
        const sku = row.dataset.sku;
        const item = cart.find(it => it.sku === sku);
        if (!item) return;

        if (e.target.closest('.inc')) item.qty = (item.qty || 1) + 1;
        if (e.target.closest('.dec')) item.qty = Math.max(1, (item.qty || 1) - 1);

        saveCart(cart);
        render();
        return;
      }
    });

    // Clear cart button
    document.getElementById('clearCart').addEventListener('click', () => {
      localStorage.removeItem('cart');
      // Tell the rest of the site we changed it (badge etc.)
      window.dispatchEvent(new CustomEvent('cart:updated', { detail: { cart: [], count: 0 }}));
      render();
    });

    // Fake "Proceed" action
    document.getElementById('checkout').addEventListener('click', () => {
      alert('Proceeding to checkout… (hook up your processor here)');
    });

    // Render on load
    render();

    // Also re-render if another tab updates the cart
    window.addEventListener('storage', (e) => {
      if (e.key === 'cart') render();
    });
    // Re-render on our cart:updated event (from cart.js)
    window.addEventListener('cart:updated', render);

    // Optional: URL switch to clear cart once: checkout.html?clearcart=1
    const u = new URLSearchParams(location.search);
    if (u.get('clearcart') === '1') {
      localStorage.removeItem('cart');
      window.dispatchEvent(new CustomEvent('cart:updated', { detail: { cart: [], count: 0 }}));
      location.replace(location.pathname);
    }
  })();
  </script>
</body>
</html>