<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout • Freedom Crate Co.</title>

  <!-- Fonts (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap" rel="stylesheet">

  <!-- Site styles -->
  <link rel="stylesheet" href="assets/css/styles.css" />
</head>
<body>

  <!-- Header -->
  <header class="site-header">
    <a class="brand" href="index.html">
      <img src="assets/img/logo.png" alt="Freedom Crate Co. logo" height="60">
    </a>
    <nav class="nav">
      <a href="index.html">Shop</a>
      <a href="contact.html">Custom Orders</a>
      <a href="checkout.html">Cart (<span id="cartCount">0</span>)</a>
    </nav>
  </header>

  <!-- Main -->
  <main class="container narrow">
    <h1>Checkout</h1>

    <!-- Cart table -->
    <table class="table cart-table" style="width:100%">
      <thead>
        <tr>
          <th style="text-align:left">Product</th>
          <th style="width:100px">Qty</th>
          <th style="width:120px">Price</th>
          <th style="width:140px">Line Total</th>
          <th style="width:100px">Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Filled by assets/js/checkout.js -->
      </tbody>
    </table>

    <!-- Total row -->
    <div class="row right" style="margin-top:1rem">
      <div class="bold" style="font-size:1.1rem">
        Total: <span id="cartTotal">$0.00</span>
      </div>
    </div>

    <!-- Actions (you can hook buttons here if needed) -->
    <div class="row right" style="gap:.5rem; margin-top:1rem">
      <a class="btn ghost" href="index.html">Continue Shopping</a>
      <!-- Example: <button class="btn">Proceed to Payment</button> -->
    </div>

    <p class="muted" style="margin-top:2rem">US Veteran-inspired • Florida-built</p>
    <p class="muted">Rugged, practical, and made to be used.</p>
  </main>

  <!-- Footer (optional) -->
  <footer class="site-footer">
    <div class="container">
      <small>&copy; <span id="year"></span> Freedom Crate Co.</small>
    </div>
  </footer>

  <script>
    // set footer year
    document.addEventListener('DOMContentLoaded', () => {
      const y = document.getElementById('year');
      if (y) y.textContent = new Date().getFullYear();
    });
  </script>

  <!-- Core site helpers -->
  <script src="assets/js/util.js" defer></script>
  <script src="assets/js/config.js" defer></script>
  <script src="assets/js/cart.js" defer></script>

  <!-- Checkout logic (renders the table and total) -->
  <script src="assets/js/checkout.js" defer></script>

  <!-- PayPal Smart Buttons (optional; replace YOUR_CLIENT_ID when you’re ready) -->
  <!-- <script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&currency=USD" defer></script> -->
</body>
</html>

    <div id="cartContainer" class="cart-card" aria-live="polite"></div>

    <div class="totals" id="totals" hidden>
      <div><strong>Subtotal</strong> <span id="subtotal">$0.00</span></div>
      <div><span>Shipping</span> <span>Free</span></div>
    </div>

    <div id="actions" hidden>
      <div id="paypal-buttons"></div>
    </div>

    <p class="muted">US Veteran-inspired • Florida-built</p>
    <p class="muted">Rugged, practical, and made to be used.</p>
  </main>

  <!-- Core site helpers -->
  <script src="assets/js/util.js"></script>
  <script src="assets/js/config.js"></script>
  <script src="assets/js/cart.js"></script>

  <!-- PayPal Smart Buttons (replace with your live client-id when ready) -->
  <script src="https://www.paypal.com/sdk/js?client-id=AcqHQkEv2VuHF_V8UL6LhZPiYQJMszdMyXK74SVqvICeoHze2onZj0SouWpYDxAaBXQtCRsPOyJhT4p8&currency=USD" defer></script>

  <script>
  (function () {
    const container = document.getElementById('cartContainer');
    const subtotalEl = document.getElementById('subtotal');
    const totalsBox  = document.getElementById('totals');
    const actionsBox = document.getElementById('actions');

    function fmt(n){ return '$' + (Number(n||0)).toFixed(2); }

    function render(){
      const cart = readCart(); // from cart.js
      const count = cart.reduce((s,i)=>s+(i.qty||1),0);
      window.dispatchEvent(new CustomEvent('cart:updated',{detail:{cart,count}})); // keep badge synced

      if (!cart.length){
        container.innerHTML = '<div class="empty">Your cart is empty.</div>';
        totalsBox.hidden = true;
        actionsBox.hidden = true;
        teardownPayPal();
        return;
      }

      container.innerHTML = '';
      let subtotal = 0;

      cart.forEach((item, idx) => {
        const row = document.createElement('div');
        row.className = 'cart-row';

        const img = document.createElement('img');
        img.src = item.image || 'assets/img/blank.jpg';
        img.alt = item.name || 'Item';

        const meta = document.createElement('div');
        meta.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
            <div>
              <div style="font-weight:600">${escapeHtml(item.name || 'Item')}</div>
              <div class="muted">SKU: ${escapeHtml(item.sku || '')}</div>
            </div>
            <div style="min-width:90px;text-align:right">${fmt(item.price || 0)}</div>
          </div>
          <div class="qty" style="margin-top:.5rem;">
            <button class="btn" data-dec>–</button>
            <span>${item.qty || 1}</span>
            <button class="btn" data-inc>+</button>
          </div>
        `;

        const remove = document.createElement('button');
        remove.className = 'remove-btn';
        remove.textContent = 'Remove';

        row.appendChild(img);
        row.appendChild(meta);
        row.appendChild(remove);
        container.appendChild(row);

        subtotal += (Number(item.price)||0) * (item.qty||1);

        // wire qty / remove
        meta.querySelector('[data-inc]').addEventListener('click', () => {
          const c = readCart(); c[idx].qty = (c[idx].qty||1) + 1; saveCart(c); render();
        });
        meta.querySelector('[data-dec]').addEventListener('click', () => {
          const c = readCart(); c[idx].qty = Math.max(1, (c[idx].qty||1) - 1); saveCart(c); render();
        });
        remove.addEventListener('click', () => {
          const c = readCart(); c.splice(idx,1); saveCart(c); render();
        });
      });

      subtotalEl.textContent = fmt(subtotal);
      totalsBox.hidden = false;
      actionsBox.hidden = false;
      setupPayPal(subtotal);
    }

    // PayPal buttons lifecycle
    let paypalButtonsInstance = null;

    function teardownPayPal(){
      if (paypalButtonsInstance && paypalButtonsInstance.isEligible()) {
        try { paypalButtonsInstance.close(); } catch(_){}
      }
      const holder = document.getElementById('paypal-buttons');
      if (holder) holder.innerHTML = '';
      paypalButtonsInstance = null;
    }

    function setupPayPal(amount){
      if (!window.paypal || !paypal.Buttons){ setTimeout(()=>setupPayPal(amount), 100); return; }
      teardownPayPal();

      paypalButtonsInstance = paypal.Buttons({
        style: { layout: 'vertical', shape: 'rect', label: 'paypal' },
        createOrder: (data, actions) => {
          const cart = readCart();
          const total = cart.reduce((s,i)=> s + (Number(i.price)||0)*(i.qty||1), 0);
          if (total <= 0) return;
          return actions.order.create({
            purchase_units: [{ amount: { value: total.toFixed(2) } }]
          });
        },
        onApprove: (data, actions) => {
          return actions.order.capture().then(() => {
            localStorage.removeItem('cart');
            window.location.href = 'thanks.html';
          });
        },
        onError: (err) => {
          console.error('PayPal error', err);
          alert('There was an issue with PayPal. Please try again.');
        }
      });

      if (paypalButtonsInstance.isEligible()){
        paypalButtonsInstance.render('#paypal-buttons');
      }
    }

    function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

    // initial render + sync
    document.addEventListener('DOMContentLoaded', render);
    window.addEventListener('storage', (e) => { if (e.key === 'cart') render(); });
    render();
  })();
  </script>
</body>
</html>
