<!doctype html>
<html lang="en">
<head>
  <meta name="robots" content="noindex, nofollow">
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DNNL0065X9"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-DNNL0065X9'); /* GA4 Measurement ID */
</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Your Cart â€“ Freedom Crate Co.</title>
  <meta name="description" content="Review your cart, update quantities, and checkout securely. Free shipping on all handcrafted ammo & range boxes." />
  <link rel="canonical" href="https://freedomcrateco.com/checkout.html">
  <link rel="stylesheet" href="assets/css/styles.css" />
  <style>
    /* Free Shipping callout */
.free-ship-callout{display:flex;gap:.75rem;align-items:center;background:rgba(34,197,94,.10);border:1px solid rgba(34,197,94,.35);color:#d1fade;padding:.75rem 1rem;border-radius:12px;margin:.75rem 0 1rem}
.free-ship-icon{font-size:1.25rem;line-height:1}
.free-ship-sub{display:block;opacity:.8;font-size:.9rem}

/* Emphasize "FREE" in totals */
.chip{display:inline-block;padding:.15rem .5rem;border-radius:.5rem;font-weight:700}
.chip-free{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.45);color:#bbf7d0}

  .cart-wrap{max-width:900px;margin:2rem auto}
  .cart-card{border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:1rem;background:rgba(255,255,255,.02)}
  .cart-row{display:grid;grid-template-columns:auto 1fr auto;gap:1rem;align-items:center;padding:1rem 0;border-top:1px solid rgba(255,255,255,.06)}
  .cart-row:first-child{border-top:0;padding-top:0}
  .cart-row img{width:84px;height:84px;object-fit:cover;border-radius:8px}
  .qty{display:flex;align-items:center;gap:.5rem}
  .qty button{width:36px;height:36px;border-radius:8px}
  .remove-btn{background:#e85b5b;border:none;color:#fff;padding:.5rem .9rem;border-radius:8px;cursor:pointer}
  .totals{display:flex;justify-content:flex-end;gap:2rem;margin:1rem 0 1.25rem}
  .totals div { min-width:200px; display:flex; justify-content:flex-end; gap:.75rem; }
  .totals div strong, .totals div > span:first-child { flex:0 0 auto; text-align:right; }
  @media (max-width:480px){ .totals div { min-width:140px; } }
  #paypal-buttons{margin-top:1rem}
  .empty{padding:2.5rem;text-align:center;color:rgba(255,255,255,.7);border:1px dashed rgba(255,255,255,.2);border-radius:10px}
  .skip-link{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
  .skip-link:focus{position:static;width:auto;height:auto;padding:.5rem;background:#000;color:#fff;border-radius:.25rem}

  /* ðŸ“± Mobile layout */
  @media (max-width:600px) {
    .cart-row {
      grid-template-columns: auto 1fr;
      grid-template-areas:
        "img meta"
        "remove remove";
      gap: 0.5rem;
    }
    .cart-row img { grid-area: img; }
    .cart-row div { grid-area: meta; }
    .cart-row .remove-btn {
      grid-area: remove;
      justify-self: center;
      margin-top: 0.6rem;
      padding: .6rem 1rem;
      border-radius: 999px;
    }
  }

  /* === Stripe button === */
  .stripe-btn {
    background: #635bff;
    color: #fff;
    font-weight: 600;
    padding: 14px 20px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 16px;
    width: 100%;          /* will be contained by #actions width */
    text-align: center;
    margin-top: 1rem;
  }
  .stripe-btn:hover {
    background: #5548c8;
  }
  .stripe-trust {
    display: block;
    text-align: center;
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: #888;
  }

  /* === Stripe width to match PayPal === */
  #actions {
    max-width: 400px;   /* same as PayPalâ€™s visual width */
    margin: 0 auto;     /* center container */
  }
  .stripe-btn {
    width: 100%;        /* button fills container */
  }
/* === Promo Code Emphasis === */
.promo-area {
  margin-top: 1rem;
}

.promo-form {
  display: flex;
  gap: .5rem;
  align-items: center;
  padding: .75rem;
  border: 1.5px solid rgba(255,255,255,.85);
  border-radius: .6rem;
  background: rgba(255,255,255,.03);

  max-width: 460px;   /* ðŸ‘ˆ controls width */
  margin: 0 auto;     /* ðŸ‘ˆ centers it */
}


.promo-form input {
  flex: 1;
  min-width: 0; /* allows flex input to shrink correctly */
  padding: .55rem .6rem;
  background: transparent;
  border: 1px solid rgba(255,255,255,.35);
  border-radius: .35rem;
  color: #fff;
}

.promo-form input::placeholder {
  color: rgba(255,255,255,.6);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.promo-message {
  margin-top: .35rem;
  font-size: .9rem;
  opacity: .85;
}

</style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>

  <header class="site-header">
    <a class="brand" href="/">
      <img src="assets/img/logo.png" alt="Freedom Crate Co. Logo">
    </a>
    <nav class="nav" aria-label="Primary">
      <a href="/">Shop</a>
      <a href="about.html">About</a>
      <a href="gallery.html">Gallery</a>
      <a href="reviews.html">Reviews</a>
      <a href="contact.html">Custom Orders</a>
      <a href="checkout.html" class="cart-link" aria-current="page">
        Cart (<span id="cartCount">0</span>)
      </a>
    </nav>
  </header>

  <main class="container cart-wrap" id="main">
    <h1>Your Cart</h1>
    <p class="shipping-note">
  Free shipping on all orders Â· Tracked via USPS
</p>


    <div id="cartContainer" class="cart-card" aria-live="polite"></div>

    <div class="totals" id="totals" hidden>
  <div><strong>Subtotal</strong> <span id="subtotal">$0.00</span></div>
  <div class="shipping">
    <span>Shipping</span>
    <span class="chip chip-free">FREE</span>
  </div>
</div>
<!-- Checkout promo code -->
<div class="promo-area" id="checkoutPromoArea">
  <form class="promo-form" id="checkoutPromoForm" autocomplete="off" novalidate>
    <input
      type="text"
      id="checkoutPromoInput"
      name="promo"
      placeholder="Promo / gift code"
      aria-label="Promo code"
    />
    <button type="submit" class="btn small">Apply</button>
  </form>
  <p id="checkoutPromoMessage" class="promo-message" aria-live="polite"></p>
</div>

    <div class="muted" role="note" aria-label="Returns policy">
      <p>Standard items may be returned within 14 days. Buyer pays return shipping.</p>
      <p>Custom orders are final sale â€” no returns or exchanges.</p>
    </div>

   <div id="actions" hidden>
  <div id="paypal-buttons"></div>

  <!-- Modern Stripe button -->
  <div class="stripe-wrap">
    <button id="stripe-pay" class="stripe-btn" type="button" aria-label="Pay with card â€” powered by Stripe">
      <span class="stripe-ico" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="5" width="20" height="14" rx="2"></rect>
          <line x1="2" y1="9" x2="22" y2="9"></line>
        </svg>
      </span>
      <span class="stripe-text">Pay with Card</span>
      <span class="stripe-secure" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="11" width="18" height="10" rx="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
        Secure
      </span>
    </button>

    <div class="stripe-trust" aria-label="Payments processed securely by Stripe">
      <span>Powered by</span>
      <strong class="stripe-word">Stripe</strong>
    </div>
  </div>
</div>

    <p class="muted">US Veteran-inspired â€¢ Florida-built</p>
    <p class="muted">Rugged, practical, and made to be used.</p>
  </main>

  <!-- Core site helpers -->
  <script src="assets/js/util.js" defer></script>
  <script src="assets/js/config.js" defer></script>
  <script src="assets/js/cart.js" defer></script>

  <!-- PayPal Smart Buttons -->
  <script src="https://www.paypal.com/sdk/js?client-id=Acgmdk8HBF7vwWZVVlNSWaSkUmiS_d8W9sPUYL3ChpldJtFOmboTxRro0ZyTxSGN8fH52gMsgcDMEDWU&currency=USD" defer></script>

  <script>
  (function () {
    const container  = document.getElementById('cartContainer');
    const subtotalEl = document.getElementById('subtotal');
    const totalsBox  = document.getElementById('totals');
    const actionsBox = document.getElementById('actions');
    const stripeBtn  = document.getElementById('stripe-pay');
   
 // ----- Simple coupon system (front-end only) -----
    const COUPON_KEY = 'fcc_coupon_v1';

    // Define the codes you actually want to use:
    // Adjust labels / percentOff exactly how you want.
        const COUPONS = {
      'FREEDOM1776': {
        label: 'Freedom 1776',
        percentOff: 15
      },
      'FREEDOMMODE': {
        label: 'Freedom Mode',
        percentOff: 15   // or 10 if you want this one to stay 10%
      },
      'FAMILY2026': {
        label: 'Family 2026',
        percentOff: 35
      }
      // Add more codes here if you want:
      // 'BLACKFRIDAY': { label: 'Black Friday', percentOff: 15 },
    };


    function FC_getActiveCoupon() {
      try {
        const raw = localStorage.getItem(COUPON_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        const code = String(parsed.code || '').toUpperCase();
        const def = COUPONS[code];
        if (!def) return null;
        return { code, ...def };
      } catch {
        return null;
      }
    }

    function setActiveCoupon(code) {
      const upper = String(code || '').toUpperCase();
      const def = COUPONS[upper];
      if (!def) {
        localStorage.removeItem(COUPON_KEY);
        return null;
      }
      localStorage.setItem(COUPON_KEY, JSON.stringify({ code: upper }));
      return { code: upper, ...def };
    }

    function clearActiveCoupon() {
      localStorage.removeItem(COUPON_KEY);
    }


    const fmt = (n) => '$' + (Number(n || 0)).toFixed(2);
    const escapeHtml = (s) => String(s).replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ));

    function render() {
      const cart = readCart();

      if (!cart.length){
        container.innerHTML = '<div class="empty">Your cart is empty.</div>';
        totalsBox.hidden = true;
        actionsBox.hidden = true;
        teardownPayPal();
        return;
      }

      container.innerHTML = '';
      cart.forEach((item) => {
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.dataset.sku = item.sku;

        const img = document.createElement('img');
        const src = (item.meta && item.meta.image) ? item.meta.image : (item.image || 'assets/img/blank.jpg');
        img.src = src;
        img.alt = item.name || 'Item';

        const meta = document.createElement('div');
        meta.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
            <div>
              <div style="font-weight:600">${escapeHtml(item.name || 'Item')}</div>
              <div class="muted">SKU: ${escapeHtml(item.sku || 'SKU-' + (item.id || 'UNKNOWN'))}</div>
            </div>
            <div style="min-width:90px;text-align:right">${fmt(item.price || 0)}</div>
          </div>
          <div class="qty" style="margin-top:.5rem;">
            <button class="btn" data-dec type="button" aria-label="Decrease quantity">â€“</button>
            <span aria-live="polite">${item.qty || 1}</span>
            <button class="btn" data-inc type="button" aria-label="Increase quantity">+</button>
          </div>
        `;

      const remove = document.createElement('button');
remove.className = 'remove-btn';
remove.type = 'button';
remove.setAttribute('aria-label', 'Remove item');
remove.innerHTML = `
  <svg viewBox="0 0 24 24" width="18" height="18" fill="none"
       stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
       aria-hidden="true">
    <polyline points="3 6 5 6 21 6"></polyline>
    <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
    <path d="M10 11v6M14 11v6"></path>
    <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
  </svg>
  <span class="sr-only">Remove</span>
`;

        row.appendChild(img);
        row.appendChild(meta);
        row.appendChild(remove);
        container.appendChild(row);

        meta.querySelector('[data-inc]').addEventListener('click', () => {
          const current = readCart().find(i => i.sku === item.sku);
          setQty(item.sku, (current?.qty || 1) + 1);
        });
        meta.querySelector('[data-dec]').addEventListener('click', () => {
          const current = readCart().find(i => i.sku === item.sku);
          setQty(item.sku, Math.max(1, (current?.qty || 1) - 1));
        });
        remove.addEventListener('click', () => removeItem(item.sku));
      });

            // --- subtotal with coupon applied ---
      const rawSubtotal = cartTotal(readCart());
      const activeCoupon = FC_getActiveCoupon();
      let discountAmt = 0;

      if (activeCoupon && activeCoupon.percentOff) {
        const pct = Math.max(0, Math.min(100, Number(activeCoupon.percentOff) || 0));
        discountAmt = (rawSubtotal * pct) / 100;
      }

      const finalSubtotal = rawSubtotal - discountAmt;

      subtotalEl.textContent = fmt(finalSubtotal);

      totalsBox.hidden = false;
      actionsBox.hidden = false;

      // Rebuild PayPal buttons so they see the latest discount
      setupPayPal();

    }

    // ---------- PayPal ----------
    let paypalButtonsInstance = null;

    function teardownPayPal(){
      if (paypalButtonsInstance && paypalButtonsInstance.isEligible && paypalButtonsInstance.isEligible()) {
        try { paypalButtonsInstance.close(); } catch(_) {}
      }
      const holder = document.getElementById('paypal-buttons');
      if (holder) holder.innerHTML = '';
      paypalButtonsInstance = null;
    }

    function buildPayPalPurchaseUnit() {
      const cart = readCart();
      const items = cart.map(i => {
        const name = i.name || 'Item';
        const sku  = i.sku || ('SKU-' + (i.id || name.replace(/\s+/g,'-').slice(0,20).toUpperCase()));
        const qty  = String(i.qty || 1);
        const unit = Number(i.price || 0).toFixed(2);
        return {
          name,
          sku,
          quantity: qty,
          unit_amount: { currency_code: 'USD', value: unit }
        };
      });

      const itemTotal = items.reduce((sum, it) => sum + (Number(it.unit_amount.value) * Number(it.quantity)), 0).toFixed(2);

// --- Apply cart-level coupon discount ---
let discountAmount = 0;
const activeCoupon = (typeof FC_getActiveCoupon === "function")
  ? FC_getActiveCoupon()
  : null;

if (activeCoupon && activeCoupon.percentOff) {
  const pct = Math.max(0, Math.min(100, Number(activeCoupon.percentOff) || 0));
  discountAmount = ((Number(itemTotal) * pct) / 100).toFixed(2);
}

      return {
  description: 'Freedom Crate Co. order',
  amount: {
    currency_code: 'USD',
    value: (Number(itemTotal) - Number(discountAmount)).toFixed(2),
    breakdown: {
      item_total: { currency_code: 'USD', value: itemTotal },
      discount:   { currency_code: 'USD', value: discountAmount }
    }
  },
  items
};

    }

    function setupPayPal(){
      if (!window.paypal || !paypal.Buttons){ setTimeout(setupPayPal, 100); return; }
      teardownPayPal();

      paypalButtonsInstance = paypal.Buttons({
        style: { layout: 'vertical', shape: 'rect', label: 'paypal' },
        createOrder: (data, actions) => {
          const unit = buildPayPalPurchaseUnit();
          if (Number(unit.amount.value) <= 0) return;
          return actions.order.create({
            purchase_units: [ unit ],
            application_context: {
              brand_name: 'Freedom Crate Co.',
              user_action: 'PAY_NOW'
            }
          });
        },
        onApprove: (data, actions) => {
          return actions.order.capture().then(() => {
            clearCart();
            window.location.href = 'order-success.html?orderId=' + encodeURIComponent(data.orderID || '');
          });
        },
        onError: (err) => {
          console.error('PayPal error', err);
          alert('There was an issue with PayPal. Please try again.');
        }
      });

      if (paypalButtonsInstance.isEligible()){
        paypalButtonsInstance.render('#paypal-buttons');
      }
    }

    // ---------- Stripe redirect ----------
stripeBtn?.addEventListener('click', async () => {
  try {
    // Grab the active coupon (Freedom Mode / promo) if there is one
    const coupon = (typeof FC_getActiveCoupon === 'function')
      ? FC_getActiveCoupon()
      : null;

    const res = await fetch('/.netlify/functions/create-checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        items: readCart(),
        coupon // <= send coupon to the Netlify function
      })
    });

    const data = await res.json();
    if (data.url) {
      window.location.href = data.url;
    } else {
      alert('Stripe checkout failed. Please try again.');
    }
  } catch (err) {
    console.error('Stripe error', err);
    alert('Stripe checkout failed.');
  }
});
    
  // ----- Promo form wiring -----
    const promoForm = document.getElementById('checkoutPromoForm');
    const promoInput = document.getElementById('checkoutPromoInput');
    const promoMsg   = document.getElementById('checkoutPromoMessage');

    if (promoForm && promoInput && promoMsg) {
      promoForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const raw = (promoInput.value || '').trim().toUpperCase();

        if (!raw) {
          clearActiveCoupon();
          promoMsg.textContent = 'Enter a promo code to apply.';
          render();
          return;
        }

        const applied = setActiveCoupon(raw);

        if (!applied) {
          promoMsg.textContent = 'That code is not valid.';
          promoForm.classList.add('promo-error');
        } else {
          promoMsg.textContent = `${applied.code} applied â€” ${applied.percentOff}% off your cart.`;
          promoForm.classList.remove('promo-error');
        }

        // Re-render to update totals and PayPal
        render();
      });

      // On load, if a coupon is already stored, show it
      const existing = FC_getActiveCoupon();
      if (existing) {
        promoInput.value = existing.code;
        promoMsg.textContent = `${existing.code} applied â€” ${existing.percentOff}% off your cart.`;
      }
    }


    document.addEventListener('DOMContentLoaded', render);
    window.addEventListener('cart:updated', render);
    window.addEventListener('storage', render);
  })();
  </script>
</body>
</html>
