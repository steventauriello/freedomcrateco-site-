<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Your Cart – Freedom Crate Co.</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
  <style>
    .cart-wrap{max-width:900px;margin:2rem auto}
    .cart-card{border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:1rem;background:rgba(255,255,255,.02)}
    .cart-row{display:grid;grid-template-columns:auto 1fr auto;gap:1rem;align-items:center;padding:1rem 0;border-top:1px solid rgba(255,255,255,.06)}
    .cart-row:first-child{border-top:0;padding-top:0}
    .cart-row img{width:84px;height:84px;object-fit:cover;border-radius:8px}
    .qty{display:flex;align-items:center;gap:.5rem}
    .qty button{width:36px;height:36px;border-radius:8px}
    .remove-btn{background:#e85b5b;border:none;color:#fff;padding:.5rem .9rem;border-radius:8px;cursor:pointer}
    .totals{display:flex;justify-content:flex-end;gap:2rem;margin:1rem 0 1.25rem}
    .totals div{min-width:180px;display:flex;justify-content:space-between}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.25)}
    #paypal-buttons{margin-top:1rem}
    .empty{padding:2.5rem;text-align:center;color:rgba(255,255,255,.7);border:1px dashed rgba(255,255,255,.2);border-radius:10px}
  </style>
</head>
<body>
  <header class="site-header">
    <a class="brand" href="index.html">
      <img src="assets/img/logo.png" alt="Freedom Crate Co. logo" height="60">
    </a>
    <nav class="nav">
      <a href="index.html">Shop</a>
      <a href="contact.html">Custom Orders</a>
      <a href="checkout.html">Cart (<span id="cartCount">0</span>)</a>
    </nav>
  </header>

  <main class="container cart-wrap">
    <h1>Your Cart</h1>

    <div id="cartContainer" class="cart-card" aria-live="polite"></div>

    <div class="totals" id="totals" hidden>
      <div><strong>Subtotal</strong> <span id="subtotal">$0.00</span></div>
      <div><span>Shipping</span> <span>Free</span></div>
    </div>

    <div id="actions" hidden>
      <button id="emptyCart" class="btn btn-ghost">Empty Cart</button>
      <div id="paypal-buttons"></div>
    </div>

    <p class="muted">US Veteran-inspired • Florida-built</p>
    <p class="muted">Rugged, practical, and made to be used.</p>
  </main>

  <!-- Core site helpers -->
  <script src="assets/js/util.js"></script>
  <script src="assets/js/config.js"></script>
  <script src="assets/js/cart.js"></script>

  <!-- PayPal Smart Buttons (replace client-id) -->
  <script src="https://www.paypal.com/sdk/js?client-id=AcqHQkEv2VuHF_V8UL6LhZPiYQJMszdMyXK74SVqvICeoHze2onZj0SouWpYDxAaBXQtCRsPOyJhT4p8&currency=USD" defer></script>

  <script>
  (function () {
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const container = document.getElementById('cartContainer');
    const subtotalEl = document.getElementById('subtotal');
    const totalsBox  = document.getElementById('totals');
    const actionsBox = document.getElementById('actions');
    const emptyBtn   = document.getElementById('emptyCart');

    function fmt(n){ return '$' + (Number(n||0)).toFixed(2); }

    function render(){
      const cart = readCart(); // from cart.js
      const count = cart.reduce((s,i)=>s+(i.qty||1),0);
      window.dispatchEvent(new CustomEvent('cart:updated',{detail:{cart,count}})); // keep badge synced

      if (!cart.length){
        container.innerHTML = '<div class="empty">Your cart is empty.</div>';
        totalsBox.hidden = true;
        actionsBox.hidden = true;
        teardownPayPal();
        return;
      }

      container.innerHTML = '';
      let subtotal = 0;

      cart.forEach((item, idx) => {
        const row = document.createElement('div');
        row.className = 'cart-row';

        const img = document.createElement('img');
        img.src = item.image || 'assets/img/blank.jpg';
        img.alt = item.name || 'Item';

        const meta = document.createElement('div');
        meta.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
            <div>
              <div style="font-weight:600">${escapeHtml(item.name || 'Item')}</div>
              <div class="muted">SKU: ${escapeHtml(item.sku || '')}</div>
            </div>
            <div style="min-width:90px;text-align:right">${fmt(item.price || 0)}</div>
          </div>
          <div class="qty" style="margin-top:.5rem;">
            <button class="btn" data-dec>–</button>
            <span>${item.qty || 1}</span>
            <button class="btn" data-inc>+</button>
          </div>
        `;

        const remove = document.createElement('button');
        remove.className = 'remove-btn';
        remove.textContent = 'Remove';

        row.appendChild(img);
        row.appendChild(meta);
        row.appendChild(remove);
        container.appendChild(row);

        subtotal += (Number(item.price)||0) * (item.qty||1);

        // wiring
        meta.querySelector('[data-inc]').addEventListener('click', () => {
          const c = readCart(); c[idx].qty = (c[idx].qty||1) + 1; saveCart(c); render();
        });
        meta.querySelector('[data-dec]').addEventListener('click', () => {
          const c = readCart(); c[idx].qty = Math.max(1, (c[idx].qty||1) - 1); saveCart(c); render();
        });
        remove.addEventListener('click', () => {
          const c = readCart(); c.splice(idx,1); saveCart(c); render();
        });
      });

      subtotalEl.textContent = fmt(subtotal);
      totalsBox.hidden = false;
      actionsBox.hidden = false;
      setupPayPal(subtotal);
    }

    emptyBtn.addEventListener('click', () => { localStorage.removeItem('cart'); render(); });

    // PayPal buttons lifecycle
    let paypalButtonsInstance = null;

    function teardownPayPal(){
      if (paypalButtonsInstance && paypalButtonsInstance.isEligible()) {
        try { paypalButtonsInstance.close(); } catch(_){}
      }
      const holder = document.getElementById('paypal-buttons');
      if (holder) holder.innerHTML = '';
      paypalButtonsInstance = null;
    }

    function setupPayPal(amount){
      // wait until SDK is loaded
      if (!window.paypal || !paypal.Buttons){ setTimeout(()=>setupPayPal(amount), 100); return; }

      teardownPayPal();

      paypalButtonsInstance = paypal.Buttons({
        style: { layout: 'vertical', shape: 'rect', label: 'paypal' },
        createOrder: (data, actions) => {
          const cart = readCart();
          const total = cart.reduce((s,i)=> s + (Number(i.price)||0)*(i.qty||1), 0);
          if (total <= 0) return;
          return actions.order.create({
            purchase_units: [{ amount: { value: total.toFixed(2) } }]
          });
        },
        onApprove: (data, actions) => {
          return actions.order.capture().then(() => {
            localStorage.removeItem('cart');
            window.location.href = 'thanks.html';
          });
        },
        onCancel: () => {
          // stay on page; nothing special
        },
        onError: (err) => {
          console.error('PayPal error', err);
          alert('There was an issue with PayPal. Please try again.');
        }
      });

      if (paypalButtonsInstance.isEligible()){
        paypalButtonsInstance.render('#paypal-buttons');
      }
    }

    // util
    function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

    // initial
    document.addEventListener('DOMContentLoaded', render);
    window.addEventListener('storage', (e) => { if (e.key === 'cart') render(); });
    // immediate render in case DOMContentLoaded already fired
    render();
  })();
  </script>
</body>
</html>