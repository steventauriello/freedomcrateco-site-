<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Product • Freedom Crate Co.</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>

  <header class="site-header">
    <a class="brand" href="index.html">
      <img src="assets/img/logo.png" alt="Freedom Crate Co." height="60" width="60">
    </a>
    <nav class="nav" aria-label="Primary">
      <a href="index.html">Shop</a>
      <a href="about.html">About</a>
      <a href="gallery.html">Gallery</a>
      <a href="reviews.html">Reviews</a>
      <a href="contact.html">Custom Orders</a>
      <a href="checkout.html" class="cart-link">Cart (<span id="cartCount">0</span>)</a>
    </nav>
  </header>

  <main id="main" class="container product-detail">
    <!-- Gallery -->
    <div class="gallery">
      <img id="pd-hero" class="product-hero" src="assets/img/blank.jpg" alt="">
      <div class="thumbs" id="pd-thumbs"></div>
    </div>

    <!-- Info -->
    <h1 id="pd-title">Loading…</h1>
    <p class="muted" id="pd-sku"></p>
    <!-- Allow real HTML lists in description -->
    <div id="pd-desc" class="muted product-description"></div>

    <div class="price-row">
      <!-- ADDED: stock badge (shown only when qty == 0) -->
      <span id="pd-stock" class="stock-badge" hidden>Out of stock</span>
      <div class="price" id="pd-price">$0.00</div>
      <div class="buy-row">
        <button class="btn" id="pd-add">Add to Cart</button>
        <button class="btn ghost" id="pd-buy">Buy Now</button>
      </div>
    </div>

    <div class="notice" id="pd-note"></div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <span class="badge">US Veteran-inspired • Florida-built</span>
      <p class="muted">Rugged, practical, and made to be used.</p>
    </div>
  </footer>

  <!-- Shared libs (order matters) -->
  <script src="assets/js/util.js" defer></script>
  <script src="assets/js/config.js" defer></script>
  <script src="assets/js/data.js" defer></script>
  <script src="assets/js/inventory.js" defer></script>
  <script src="assets/js/cart.js" defer></script>

  <!-- Product loader -->
  <script>
  (async function () {
    // -------- Helpers --------
    const ensurePath = (src) => {
      const s = String(src || '').trim();
      if (!s) return 'assets/img/blank.jpg';
      if (/^https?:\/\//i.test(s)) return s;
      if (s.startsWith('assets/')) return s;
      return 'assets/img/' + s.replace(/^\/+/, '');
    };

    const toImgArray = (images) => {
      if (Array.isArray(images)) return images.map(ensurePath);
      if (!images) return [];
      return String(images)
        .split(/[|,]/)
        .map(s => s.trim())
        .filter(Boolean)
        .map(ensurePath);
    };

    // Minimal whitelist sanitizer for product descriptions
    function allowSafeHTML(str = '') {
      const div = document.createElement('div');
      div.innerHTML = str;
      const allowed = new Set(['BR','STRONG','EM','UL','OL','LI']);
      div.querySelectorAll('*').forEach(el => {
        if (!allowed.has(el.tagName)) {
          const span = document.createElement('span');
          span.textContent = el.textContent;
          el.replaceWith(span);
        } else {
          [...el.attributes].forEach(a => el.removeAttribute(a.name));
        }
      });
      return div.innerHTML;
    }

    // -------- Get SKU from URL --------
    const params = new URLSearchParams(location.search);
    const sku = params.get('sku');
    if (!sku) { location.href = 'index.html'; return; }

    // -------- Load product data (wait for data.js) --------
    while (!window.FC || typeof window.FC.loadProducts !== 'function') {
      await new Promise(r => setTimeout(r, 10));
    }
    const all = await window.FC.loadProducts();
    const P = all.find(p => String(p.sku) === String(sku));
    if (!P) { location.href = 'index.html'; return; }

    // -------- DOM refs --------
    const hero    = document.getElementById('pd-hero');
    const thumbs  = document.getElementById('pd-thumbs');
    const titleEl = document.getElementById('pd-title');
    const skuEl   = document.getElementById('pd-sku');
    const descEl  = document.getElementById('pd-desc');
    const priceEl = document.getElementById('pd-price');
    const addBtn  = document.getElementById('pd-add');
    const buyBtn  = document.getElementById('pd-buy');
    const noteEl  = document.getElementById('pd-note');
    const stockEl = document.getElementById('pd-stock'); /* ADDED */

    // -------- Data -> UI --------
    titleEl.textContent = P.title || P.sku;
    document.title = (P.title || P.sku) + ' • Freedom Crate Co.';
    skuEl.textContent = 'SKU: ' + P.sku;

    // Render description with safe HTML (supports <ul>,<li>,<br>,<strong>,<em>)
    descEl.innerHTML = allowSafeHTML(P.description || '');

    // Price
    priceEl.textContent = '$' + Number(P.price || 0).toFixed(2);
    if (P.note) noteEl.textContent = P.note;

    // -------- Images --------
    const imgs = toImgArray(P.images);
    if (!imgs.length) imgs.push(ensurePath(P.image_url));
    const setHero = (src, alt) => { hero.src = src; hero.alt = alt || P.title; };
    setHero(imgs[0], P.title);

    thumbs.innerHTML = '';
    imgs.forEach((src, i) => {
      const t = document.createElement('img');
      t.src = src; t.alt = `${P.title} ${i+1}`;
      t.addEventListener('click', () => setHero(src, t.alt));
      thumbs.appendChild(t);
    });

    // -------- Lightbox --------
    hero.style.cursor = 'zoom-in';
    hero.addEventListener('click', () => {
      const lb = document.createElement('div');
      lb.className = 'lightbox open';
      lb.innerHTML = '<img src="' + hero.src + '" alt="' + hero.alt + '"><div class="close">×</div>';
      lb.querySelector('.close').onclick = () => lb.remove();
      lb.onclick = (e) => { if (e.target === lb) lb.remove(); };
      document.body.appendChild(lb);
    });

    // -------- Inventory badge (ONLY show when qty == 0) --------
    let qty = Number(P.qty ?? 0);
    if (qty <= 0) {
      stockEl.textContent = 'Out of stock';
      stockEl.hidden = false;      // show badge
      addBtn.disabled = true;      // disable purchase buttons
      buyBtn.disabled = true;
    } else {
      stockEl.hidden = true;       // hide badge for any qty > 0
      addBtn.disabled = false;
      buyBtn.disabled = false;
    }

    // -------- Cart helpers --------
    const addToCartSafe = (sku, name, price, qty, meta) =>
      (typeof window.addToCart === 'function')
        ? window.addToCart(sku, name, price, qty, meta)
        : console.warn('Cart not ready');

    const buyNowSafe = (sku, name, price, qty, meta) =>
      (typeof window.buyNow === 'function')
        ? window.buyNow(sku, name, price, qty, meta)
        : console.warn('Cart not ready');

    const meta = { image: hero.src };
    addBtn.addEventListener('click', () => addToCartSafe(P.sku, P.title, Number(P.price||0), 1, meta));
    buyBtn.addEventListener('click', () => buyNowSafe(P.sku, P.title, Number(P.price||0), 1, meta));
  })();
  </script>

  <div id="sr-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>

  <!-- Optional quick style if you don't already have one:
  <style>
    .stock-badge{display:inline-block;margin-right:.5rem;padding:.3rem .55rem;border-radius:.5rem;font-weight:700;font-size:.85rem;background:#dc2626;color:#fff;}
  </style>
  -->
</body>
</html>