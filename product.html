<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Default (updated dynamically per SKU) -->
  <title>Product • Freedom Crate Co.</title>
  <meta name="description" content="Freedom Crate Co. builds handcrafted wooden ammo crates, range boxes, and military-inspired storage boxes. Rugged, veteran-inspired, built to last." />
  <meta name="keywords" content="wood military ammo box, wooden ammo boxes, handcrafted range boxes, Freedom Crate Co, veteran inspired storage" />
  <meta name="author" content="Freedom Crate Co." />
  <link rel="canonical" href="https://freedomcrateco.com/product.html" />

  <!-- Open Graph -->
  <meta property="og:type" content="product" />
  <meta property="og:title" content="Freedom Crate Co. – Handcrafted Ammo & Range Boxes" />
  <meta property="og:description" content="Hand-built wooden ammo crates and range boxes with lockable hardware and military-inspired stencils. Free shipping." />
  <meta property="og:url" content="https://freedomcrateco.com/product.html" />
  <meta property="og:image" content="https://freedomcrateco.com/assets/img/logo.png" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Freedom Crate Co. – Handcrafted Ammo & Range Boxes" />
  <meta name="twitter:description" content="Handcrafted wooden ammo and range boxes. Rugged, functional, veteran-inspired. Free shipping." />
  <meta name="twitter:image" content="https://freedomcrateco.com/assets/img/logo.png" />

  <link rel="stylesheet" href="assets/css/styles.css" />

  <!-- Page-scoped styles for gallery arrows (no changes needed in styles.css) -->
  <style>
    .gallery { position: relative; }
    .gallery-arrow{
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 42px; height: 42px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.25);
      background: rgba(0,0,0,.55);
      color: #fff;
      font-size: 24px;
      line-height: 40px;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }
    .gallery-arrow.prev{ left: 8px; }
    .gallery-arrow.next{ right: 8px; }
    .gallery .thumbs img.is-active{ outline: 2px solid var(--brand); outline-offset: 2px; }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>

  <header class="site-header">
    <a class="brand" href="index.html">
      <img src="assets/img/logo.png" alt="Freedom Crate Co." height="60" width="60">
    </a>
    <nav class="nav" aria-label="Primary">
      <a href="index.html">Shop</a>
      <a href="about.html">About</a>
      <a href="gallery.html">Gallery</a>
      <a href="reviews.html">Reviews</a>
      <a href="contact.html">Custom Orders</a>
      <a href="checkout.html" class="cart-link">Cart (<span id="cartCount">0</span>)</a>
    </nav>
  </header>

  <main id="main" class="container product-detail">
    <!-- Gallery -->
    <div class="gallery">
  <div class="hero-wrap">
    <img id="pd-hero" class="product-hero" src="assets/img/blank.jpg" alt="">

    <!-- arrows INSIDE hero-wrap -->
    <button class="gallery-arrow prev" type="button" aria-label="Previous image">‹</button>
    <button class="gallery-arrow next" type="button" aria-label="Next image">›</button>
  </div>

  <div class="thumbs" id="pd-thumbs"></div>
</div>

    <!-- Info -->
    <h1 id="pd-title">Loading…</h1>
    <p class="muted" id="pd-sku"></p>
    <div id="pd-desc" class="muted product-description"></div>

    <div class="price-row">
      <span id="pd-stock" class="stock-badge" hidden>Out of stock</span>
      <div class="price" id="pd-price">$0.00</div>
      <div class="buy-row">
        <button class="btn" id="pd-add">Add to Cart</button>
        <button class="btn ghost" id="pd-buy">Buy Now</button>
      </div>
    </div>

    <div class="notice" id="pd-note"></div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <span class="badge">US Veteran-inspired • Florida-built</span>
      <p class="muted">Rugged, practical, and made to be used.</p>
    </div>
  </footer>

  <!-- Shared libs -->
  <script src="assets/js/util.js" defer></script>
  <script src="assets/js/config.js" defer></script>
  <script src="assets/js/data.js" defer></script>
  <script src="assets/js/inventory.js" defer></script>
  <script src="assets/js/cart.js" defer></script>

  <!-- Product loader with SEO injection + arrow cycling -->
  <script>
  (async function () {
    const ensurePath = (src) => {
      const s = String(src || '').trim();
      if (!s) return 'assets/img/blank.jpg';
      if (/^https?:\/\//i.test(s)) return s;
      if (s.startsWith('assets/')) return s;
      return 'assets/img/' + s.replace(/^\/+/, '');
    };

    const toImgArray = (images) => {
      if (Array.isArray(images)) return images.map(ensurePath);
      if (!images) return [];
      return String(images).split(/[|,]/).map(s => s.trim()).filter(Boolean).map(ensurePath);
    };

    function allowSafeHTML(str = '') {
      const div = document.createElement('div');
      div.innerHTML = str;
      const allowed = new Set(['BR','STRONG','EM','UL','OL','LI']);
      div.querySelectorAll('*').forEach(el => {
        if (!allowed.has(el.tagName)) {
          const span = document.createElement('span');
          span.textContent = el.textContent;
          el.replaceWith(span);
        } else {
          [...el.attributes].forEach(a => el.removeAttribute(a.name));
        }
      });
      return div.innerHTML;
    }

    // SKU from URL (works for both localhost and production)
const params = new URLSearchParams(location.search);
let sku = params.get('sku') || (location.hash ? location.hash.slice(1) : '');

// Optional: default SKU for dev testing
if (!sku && ['localhost','127.0.0.1'].includes(location.hostname)) {
  sku = 'FC-RM-400';
  history.replaceState(null, '', location.pathname + '#' + sku);
}

// Default to Branch Collection (FC-CLASSIC) — no redirect
if (!sku) {
  sku = 'FC-CLASSIC';
  const u = new URL(location.href);
  u.searchParams.set('sku', sku);
  history.replaceState(null, '', u.toString());
}

    // Wait until product loader is ready
    while (!window.FC || typeof window.FC.loadProducts !== 'function') {
      await new Promise(r => setTimeout(r, 10));
    }
    const all = await window.FC.loadProducts();
    let P = all.find(p => String(p.sku) === String(sku));
if (!P) {
  // Fall back silently to default product (no redirect)
  sku = 'FC-CLASSIC';
  const u = new URL(location.href);
  u.searchParams.set('sku', sku);
  history.replaceState(null, '', u.toString());
  P = all.find(p => String(p.sku) === 'FC-CLASSIC');
}

    // DOM refs
    const hero    = document.getElementById('pd-hero');
    const thumbs  = document.getElementById('pd-thumbs');
    const titleEl = document.getElementById('pd-title');
    const skuEl   = document.getElementById('pd-sku');
    const descEl  = document.getElementById('pd-desc');
    const priceEl = document.getElementById('pd-price');
    const addBtn  = document.getElementById('pd-add');
    const buyBtn  = document.getElementById('pd-buy');
    const noteEl  = document.getElementById('pd-note');
    const stockEl = document.getElementById('pd-stock');

    // Data -> UI
    titleEl.textContent = P.title || P.sku;
    document.title = (P.title || P.sku) + " • Freedom Crate Co. | Wooden Military Ammo Box";
    skuEl.textContent = 'SKU: ' + P.sku;
    descEl.innerHTML = allowSafeHTML(P.description || '');
    priceEl.textContent = '$' + Number(P.price || 0).toFixed(2);
    if (P.note) noteEl.textContent = P.note;

    // Images
    const imgs = toImgArray(P.images);
    if (!imgs.length) imgs.push(ensurePath(P.image_url));
    const setHero = (src, alt) => { hero.src = src; hero.alt = alt || P.title; };
    setHero(imgs[0], P.title);

    thumbs.innerHTML = '';
    imgs.forEach((src, i) => {
      const t = document.createElement('img');
      t.src = src; t.alt = `${P.title} ${i+1}`;
      t.addEventListener('click', () => show(i));
      thumbs.appendChild(t);
    });

    // Arrow / cycling controls
    const prevBtn = document.querySelector('.gallery .gallery-arrow.prev');
    const nextBtn = document.querySelector('.gallery .gallery-arrow.next');
    const thumbEls = Array.from(thumbs.querySelectorAll('img'));
    let idx = 0;

    function show(i){
      const n = thumbEls.length;
      if (!n) return;
      idx = (i % n + n) % n;
      const t = thumbEls[idx];
      const src = t.dataset.full || t.src;
      const alt = t.alt || `Photo ${idx+1}`;
      const tmp = new Image();
      tmp.onload = () => { setHero(src, alt); };
      tmp.src = src;
      thumbEls.forEach((el,j) => el.classList.toggle('is-active', j === idx));
    }

    if (prevBtn && nextBtn && thumbEls.length){
      prevBtn.addEventListener('click', () => show(idx - 1));
      nextBtn.addEventListener('click', () => show(idx + 1));

      // keyboard support (left/right) when gallery has focus
      const galleryEl = document.querySelector('.gallery');
      if (galleryEl) {
        galleryEl.setAttribute('tabindex','0');
        galleryEl.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowLeft')  { e.preventDefault(); show(idx - 1); }
          if (e.key === 'ArrowRight') { e.preventDefault(); show(idx + 1); }
        });
      }

      // init
      show(0);
    }

    // Stock badge
    let qty = Number(P.qty ?? 0);
    if (qty <= 0) {
      stockEl.textContent = 'Out of stock';
      stockEl.hidden = false;
      addBtn.disabled = true;
      buyBtn.disabled = true;
    }

    // Inject SEO meta dynamically
    const metaDesc = document.querySelector('meta[name="description"]');
    if (metaDesc) metaDesc.setAttribute("content", (P.description || "Handcrafted wooden ammo box.") + " Buy now at Freedom Crate Co.");
    const ogTitle = document.querySelector('meta[property="og:title"]');
    if (ogTitle) ogTitle.setAttribute("content", P.title + " | Freedom Crate Co.");
    const ogImage = document.querySelector('meta[property="og:image"]');
    if (ogImage && imgs[0]) {
      const absolute = imgs[0].startsWith('http') ? imgs[0] : (location.origin + "/" + imgs[0].replace(/^\/+/, ''));
      ogImage.setAttribute("content", absolute);
    }
// Canonical & og:url (self-canonical to the exact SKU)
const url = new URL(location.href);
const canonicalUrl = url.origin + url.pathname + '?sku=' + encodeURIComponent(sku);


// <link rel="canonical">
let link = document.querySelector('link[rel="canonical"]');
if (!link) { link = document.createElement('link'); link.rel = 'canonical'; document.head.appendChild(link); }
link.href = canonicalUrl;

// og:url
let og = document.querySelector('meta[property="og:url"]');
if (!og) { og = document.createElement('meta'); og.setAttribute('property','og:url'); document.head.appendChild(og); }
og.setAttribute('content', canonicalUrl);

// === Product JSON-LD with conditional return policy ===
const toAbs = src => (String(src).startsWith('http') ? src
  : (location.origin + "/" + String(src).replace(/^\/+/, "")));

const PRICE_VALID_UNTIL = (() => { const d = new Date(); d.setFullYear(d.getFullYear()+1,11,31); return d.toISOString().slice(0,10); })();

// Heuristic: treat as custom if P.returnable === false OR SKU/title mentions custom/stencil
const looksCustom = (
  P.returnable === false ||
  /custom|stencil/i.test(String(P.title)) ||
  /custom|stencil/i.test(String(P.sku))
);

const RETURN_POLICY = looksCustom
  ? {
      "@type": "MerchantReturnPolicy",
      "returnPolicyCategory": "https://schema.org/NonReturnable",
      "applicableCountry": "US"
    }
  : {
      "@type": "MerchantReturnPolicy",
      "returnPolicyCategory": "https://schema.org/MerchantReturnFiniteReturnWindow",
      "merchantReturnDays": 14,
      "applicableCountry": "US",
      "returnMethod": "https://schema.org/MailReturn",
      "returnFees": "https://schema.org/ReturnShippingFees"
    };

const SHIPPING_DETAILS = {
  "@type": "OfferShippingDetails",
  "shippingRate": { "@type": "MonetaryAmount", "value": "0.00", "currency": "USD" },
  "shippingDestination": { "@type": "DefinedRegion", "addressCountry": "US" },
  "deliveryTime": {
    "@type": "ShippingDeliveryTime",
    "handlingTime": { "@type": "QuantitativeValue", "minValue": 1, "maxValue": 3, "unitCode": "DAY" },
    "transitTime":  { "@type": "QuantitativeValue", "minValue": 2, "maxValue": 6, "unitCode": "DAY" }
  }
};

const ld = {
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": P.title,
  "sku": P.sku,
  "url": canonicalUrl,
  "image": imgs.map(toAbs),
  "description": P.description || "Handcrafted wooden ammo box.",
  "brand": { "@type": "Brand", "name": "Freedom Crate Co." },
  "offers": {
    "@type": "Offer",
    "price": Number(P.price || 0).toFixed(2),
    "priceCurrency": "USD",
    "priceValidUntil": PRICE_VALID_UNTIL,
    "availability": qty > 0 ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
    "url": canonicalUrl,
    "seller": { "@type": "Organization", "name": "Freedom Crate Co.", "url": location.origin },
    "hasMerchantReturnPolicy": RETURN_POLICY,
    "shippingDetails": SHIPPING_DETAILS
  }
};

const script = document.createElement("script");
script.type = "application/ld+json";
script.textContent = JSON.stringify(ld);
document.head.appendChild(script);
    // Cart hooks (unchanged)
    const addToCartSafe = (sku, name, price, qty, meta) =>
      (typeof window.addToCart === 'function')
        ? window.addToCart(sku, name, price, qty, meta)
        : console.warn('Cart not ready');

    const buyNowSafe = (sku, name, price, qty, meta) =>
      (typeof window.buyNow === 'function')
        ? window.buyNow(sku, name, price, qty, meta)
        : console.warn('Cart not ready');

    addBtn.addEventListener('click', () => {
      addToCartSafe(P.sku, P.title, Number(P.price || 0), 1, { image: hero.src });
    });

    buyBtn.addEventListener('click', () => {
      buyNowSafe(P.sku, P.title, Number(P.price || 0), 1, { image: hero.src });
    });
  })();
  </script>

  <div id="sr-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>
</body>
</html>